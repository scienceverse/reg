---
title: "Export Study"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Export Study}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(scienceverse)
```

Once you've created a scienceverse study, you can set up files from the meta-study file. Here's a simple example testing group differences and simulating the data for the groups.

```{r}
s <- study("Demo") %>%
  add_sim_data("dat", 
               within = list(time = c("morning", "night")),
               between = list(group = c("A", "B")), 
               mu = list(A = c(105, 100), 
                         B = c(105, 100)), 
               n = 30, r = 0.5, sd = 10, dv = "size", 
               long = TRUE, plot = TRUE
  )
```


```{r}
s <- s %>%
  add_hypothesis("group", "Group A will be bigger than group B") %>%
  add_analysis("A1", t.test(size~group, dat)) %>%
  add_criterion("p", "p.value", "<", 0.05) %>%
  add_criterion("dir", "estimate[1]", ">", "estimate[2]") %>%
  add_eval("c", "significant in predicted direction", "p & dir") %>%
  add_eval("f", "significant in unpredicted direction", "p & !dir") %>%
  
  add_hypothesis("time", "Subjects will be bigger in the morning than at night") %>%
  add_analysis("A2", t.test(size~time, dat)) %>%
  add_criterion("p", "p.value", "<", 0.05) %>%
  add_criterion("dir", "estimate[1]", ">", "estimate[2]") %>%
  add_eval("c", "significant in predicted direction", "p & dir") %>%
  add_eval("f", "significant in unpredicted direction", "p & !dir") %>%
  study_analyse()
```

You can save the study in JSON (machine-readable) format and reload it later. 

```{r}
study_save(s, "study.json")

s <- study("study.json")
```


You can get all the results with the `get_result()` function. If you don't specify the result name or the analysis ID, it defaults to all of the results of the first analysis. It retruns a list that you can use, but will display an RMarkdown-formatted list if you print it (and set the chunk options to `results='asis'`).

```{r, results='asis'}
get_result(s)
```

Get a specific result from a specific analysis.

```{r}
get_result(study = s, 
           result = "p.value", 
           analysis_id = "A2", 
           digits = 3,
           return = "value")
```

Set `value` to `char` if you want to keep trailing zeros (return the number as a character string).

```{r}
get_result(study = s, 
           result = "parameter", 
           analysis_id = 1, 
           digits = 3,
           return = "char")
```

You can display the value as a link to the analysis file (created with `make_script`). The digits default to the global option, so you can reset that. And you can use the shorthand function `get_html` if you only have one study object loaded. The analysis link defaults to "analysis.html", but you can change this with `scienceverse_options()` as shown.

```{r, message=FALSE}
make_script(s, "analysis.Rmd")
rmarkdown::render("analysis.Rmd")
options(digits = 3)
scienceverse_options(analysis_link = "analysis.html")
get_html("p.value")
```

You'll probably want to use `get_html()` inline most of the time like this: 

For hypothesis 1, the subjects in group A were not any bigger than those in group B 
  (t = `r get_html("statistic", 1, 2)`, 
  df = `r get_html("parameter", 1, 1)`, 
  p = `r get_html("p.value", 1, 3)`,
  95% CI = [`r get_html("conf.int[1]", 1, 2)`, 
             `r get_html("conf.int[2]", 1, 2)`]).
  
For hypothesis 1, the subjects were larger in the morning than at night 
  (t = `r get_html("statistic", 2, 2)`, 
  df = `r get_html("parameter", 2, 1)`, 
  p = `r get_html("p.value", 2, 3)`,
  95% CI = [`r get_html("conf.int[1]", 2, 2)`, 
             `r get_html("conf.int[2]", 2, 2)`]).

